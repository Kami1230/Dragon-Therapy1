// Initialize Floating Chatbot
function initFloatingChatbot() {
    const chatToggleBtn = document.getElementById('chat-toggle-btn');
    const chatbotContainer = document.getElementById('floating-chatbot-container');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const chatbox = document.getElementById('chatbox');
    let hasGreeted = false;

    // Chatbot toggle logic
    chatToggleBtn.addEventListener('click', () => {
        chatbotContainer.classList.toggle('is-visible');
    });

    // Helper function to add messages to the chatbox
    function addMessageToChatbox(text, sender) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message");
        messageDiv.classList.add(sender === "user" ? "user-message" : "system-message");
        messageDiv.textContent = text;
        chatbox.appendChild(messageDiv);
        chatbox.scrollTop = chatbox.scrollHeight;
    }
    // Chatbot send message logic
    chatSendBtn.addEventListener("click", async () => {
        const userMessage = chatInput.value.trim();
        if (userMessage === "") return;

        if (!hasGreeted) {
            chatbox.innerHTML = "";
            hasGreeted = true;
        }

        addMessageToChatbox(userMessage, "user");
        chatInput.value = "";

        try {
            addMessageToChatbox("Typing...", "system");
            const response = await fetch('http://localhost:3000/chatbot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: userMessage, data: patientData })
            });

            const result = await response.json();
            chatbox.removeChild(chatbox.lastChild);
            addMessageToChatbox(result.response, "system");
        } catch (e) {
            chatbox.removeChild(chatbox.lastChild);
            addMessageToChatbox("Sorry, I could not process that request.", "system");
            console.error("Chatbot error:", e);
        }
    });

    chatInput.addEventListener("keypress", (event) => {
        if (event.key === "Enter") {
            chatSendBtn.click();
        }
    });
}